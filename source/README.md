# 项目介绍

贾宇昊 520021911157  选择题目：聊天程序

[TOC]

## 概述

##### 运行环境：python 3.10

##### 编译工具：pyinstaller

##### 程序文件列表

![屏幕截图 2022-12-26 202032](E:\大三上\计算机通信网络\大作业\屏幕截图 2022-12-26 202032.png)

- build:存放编译产生的文件
- dist:存放编译完成的可执行文件
- record_cache：存放聊天记录和客户端传输的文件
- src：存放图片资源和其他界面的UI文件
- client_config.json：服务器的IP地址和服务端口
- client.py：客户端文件
- db_init.py：建立并初始化数据库
- main.exe：客户端可执行文件
- main.py：客户端入口
- Mainwindow.py：聊天界面的UI文件
- Mylogin.py：处理客户端UI逻辑
- rec_rc.py：Qt编译产生的资源文件
- server_db.py：服务器处理数据库的函数
- server.db：服务器数据库
- server.exe:服务器可执行文件
- Ui_recv_win.py：私人聊天界面的UI文件



## 主要算法

### 登录算法

#### 退出

客户端退出请求：{"login" = 0，"args":"exit"}

服务器退出响应：不响应，直接关闭该用户的套接字



#### 登录

客户端登录请求：{“login” = 1,"args":{"Email":"邮箱""password":"密码"}}

服务器登录响应：{"login" = 1,"return" = 0   }  #登录成功返回0，邮箱不存在返回2，密码错误返回1，已经登录返回3



#### 注册

客户端注册请求：{"login" = 2,"args":{“Email”："邮箱"，"user_name":"昵称"，"password":"密码"}}

服务器注册响应：{"login":2，"return" = 0}      #注册成功返回0，邮箱存在返回1



#### 修改密码

客户端修改密码请求：{"login" = 3，"args":{"Email":"账号"，"old_password":"旧密码"，"new_password":“新密码”}}

服务器修改密码响应：{"login":3，"return" = 0}    #修改成功返回0，邮箱不存在返回1，旧密码错误返回2



#### 忘记密码

用户忘记密码时，会直接重置密码

客户端重置密码请求：{"login" = 4，"args":{"Email":"邮箱账号","new_password":“新密码”}}

服务器重置密码响应：{"login"= 4,"return" = 0 }     #重置密码成功返回0，邮箱不存在返回1



### 聊天算法

#### 群聊

客户端群聊请求：{"group":发送方邮箱,"message":消息}

服务器向除发送方外的所有在线用户发送响应{"group":发送方邮箱,"message":消息}

#### 私聊

客户端私聊请求：{"person_talk":接受方邮箱,"message":消息}

服务器向接受方发送响应：{"person_talk":发送方邮箱,"message":消息}



### 在线和离线同步

#### 服务器

服务器维护一个在线用户列表，每一个用户登录成功后，服务器将该用户添加到在线用户列表中，并向所有用户广播{"online":在线邮箱的列表}，每一个用户下线后，服务器接收到该用户的离线信息，将该用户从在线用户列表中删除，并向所有在线用户广播{"down_line":离线的邮箱}。

#### 客户端

客户端登录后收到服务器广播的在线用户列表，创建并维护自己的在线用户列表，为除自己外的用户创建私聊窗口，开始标志为0，收到私聊消息后，将发送方的私聊窗口打开进行私聊，收到服务器的用户下线信息后，将该用户从在线用户列表中删除。



### 文件传送

只有在私聊界面才能进行文件传送。

客户端1传送文件请求：{"personal_file":接收方邮箱, "file_name":文件名  "file_size": 文件大小  "file_md5": 文件校验码    "file_req": 文件序号    "send_ok" : 1}

客户端2接收文件请求{"personal_file":接收方邮箱,"recv_file":1/0 ,  "file_req": 文件序号"file_name":文件名  "file_size": 文件大小}

如果 recv_file == 1，客户端1开始传输文件，服务器转发给客户端2

## 主要数据结构

### 数据库

![屏幕截图 2022-12-26 225547](E:\大三上\计算机通信网络\大作业\屏幕截图 2022-12-26 225547.png)

用户注册时，会在服务器数据库写三个字段，邮箱Email，名称 user_name，密码的MD5值。Email为键值，每个用户不能相同。

当前已有的用户有 123456789@qq.com，987654321@qq.com，3136365838@qq.com，12345678@qq.com，密码均为123456，

@为管理员用户，密码为123456。

### Mylogin.py

Mylogin.py中有重要的数据结构

##### class Mylogin

处理用户登录界面

##### class Myregister

处理用户注册界面

##### class Myforget_password

处理用户忘记密码界面

##### class Mymodify_password

处理用户修改密码界面

##### class Myrecvtalk

处理用户私聊界面

##### class MyMainForm

处理用户主界面

##### class Myexp

处理用户表情功能

##### class Myrecord

处理用户查看聊天记录功能

## 程序测试截图及说明

#### 登录

首先要运行server.py程序，监听登录请求。

![1](E:\大三上\计算机通信网络\大作业\1.png)

在命令行运行main.py，或点击main.exe，打开客户端登录界面。

![2](E:\大三上\计算机通信网络\大作业\2.png)

用户填写邮箱和密码进行登录。

#### 注册

点击register按钮进行注册。

![注册](E:\大三上\计算机通信网络\大作业\注册.png)

新用户填写邮箱，名称，密码即可成功注册。

#### 修改密码

在登录界面点击modify按钮修改密码

![修改密码](E:\大三上\计算机通信网络\大作业\修改密码.png)

#### 忘记密码

如果用户忘记密码，则可以直接重置密码

![忘记密码](E:\大三上\计算机通信网络\大作业\忘记密码.png)

#### 主界面

在登录界面填写邮箱和密码后，如果登录成功则可以进入主界面

![主界面](E:\大三上\计算机通信网络\大作业\主界面.png)

主界面中间的四个按钮的功能是：表情、截图、发送文件、查看聊天记录，其中截图功能还未开发。

将该界面拖至电脑右边可以缩小化。

![主界面缩小](E:\大三上\计算机通信网络\大作业\主界面缩小.png)

上图中，使用3136365838@qq.com邮箱登录，第一个用户的主界面缩小在屏幕右边，点击关闭按钮后该用户下线。

点击主界面右上角的按钮可以查看连接到服务器的在线用户列表。

![在线文件列表](E:\大三上\计算机通信网络\大作业\在线文件列表.png)

在主界面下方的文本框中输入字符，按下回车可以在群聊中发送信息。

![群聊展示](E:\大三上\计算机通信网络\大作业\群聊展示.png)

点击主界面的查询聊天记录按钮(右一)，可以查询群聊的聊天记录。

![群聊聊天记录](E:\大三上\计算机通信网络\大作业\群聊聊天记录.png)

在用户主页面点击用户列表的其他用户，可以打开私聊窗口

![私聊展示](E:\大三上\计算机通信网络\大作业\私聊展示.png)

在私聊页面也可以查询聊天记录

![私聊聊天记录](E:\大三上\计算机通信网络\大作业\私聊聊天记录.png)

聊天过程中点击表情按钮可以添加表情。

![表情展示](E:\大三上\计算机通信网络\大作业\表情展示.png)

点击传输文件按钮(左三)，打开选择文件界面

![选择文件](E:\大三上\计算机通信网络\大作业\选择文件.png)

文件传输支持任何文件类型，这里选择client.py

![发送文件请求](E:\大三上\计算机通信网络\大作业\发送文件请求.png)

选择文件后，Alice发送了传输文件的请求，Miliki的私聊页面出现了该文件。

![3](E:\大三上\计算机通信网络\大作业\3.png)

点击右边对应的文件，则表示接收该文件，对方可以开始传输

![文件传输](E:\大三上\计算机通信网络\大作业\文件传输.png)

发送方传输完成后会提示接收方，接收方接收后会比较文件的MD5值，如果一致则通知对方接收成功。

![文件传输打开](E:\大三上\计算机通信网络\大作业\文件传输打开.png)

接收成功的文件会在接收方对应的文件夹下。

![传输文件打开](E:\大三上\计算机通信网络\大作业\传输文件打开.png)

打开该文件，与源文件一致，传输成功。

## 遇到的问题及解决方法

程序的总体开发流程很长，遇到过很多的问题，在此只挑选几个印象深刻的问题。

##### 文件传输的编码问题

一开始我的设想是文件传输时也为每一个数据报制作报头，以便服务器知道这是用于文件传输的数据报，知道该数据报属于哪一个文件。但是这样做的问题是文件编码很困难，二进制的格式无法和报头兼容，使用utf-8等方式编码，常常会有文件乱码的问题。

最后的解决方式是，先发送一个单独的数据报用于双方通知和同步，再使用二进制格式打开文件并传输。

##### 文件传输的多进程问题

在文件接收时，如果使用多进程技术，极易出现接收混乱问题。

解决方法是，做好多进程的同步工作。

##### 使用表情后，无法查看聊天记录

聊天记录使用txt格式的文件存储，存入表情后如果文件的解码格式错误，则无法打开读取文件。

解决方法：统一使用utf-8编解码。

## 体会与建议

这是一门让我收获很大的课程。

从编程知识方面，这门课带领我入门了网络编程开发。以聊天程序为例，我学会了使用系统的socket库进行编程，这也促进了我对课程内传输层的知识的理解。

从软件开发方面，我体验了软件开发的流程并收获了一些经验，并以一个项目的形式作为实际练习。我认为一些实际的开发经验有时比开发所需要的知识更重要。从需求分析到多轮迭代，再到对产品的测试、重构，通过将近半个学期的投入，我也熟悉这一套流程，并对每一个环节的关键性有了深入的了解。

下面是对该课程的建议：

1. 平时的课程过于注重理论，实践部分仅仅有最后的大作业，大作业的有些选题只能增加对应用层的理解，而对于传输层以下的理论没有很好的印证。建议在课程进行中，每学完一个大章节就配置相应的lab，帮助学生理解。
2. 教材内容太过晦涩难懂，布置的有些练习题课上和教材上都没有讲到，给学习知识带来了很大的障碍。建议上完一个章节后及时安排习题课，而不是拖到学期末尾。